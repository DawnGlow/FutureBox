<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: header}">
    <title>통계 대시보드</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
    <h2 class="text-center my-4">통계 대시보드</h2>

    <!-- 기간 선택 폼 -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-auto">
                    <label for="startDate" class="form-label">시작일</label>
                    <input type="date" class="form-control" id="startDate" name="startDate" 
                           th:value="${startDate}">
                </div>
                <div class="col-auto">
                    <label for="endDate" class="form-label">종료일</label>
                    <input type="date" class="form-control" id="endDate" name="endDate" 
                           th:value="${endDate}">
                </div>
                <div class="col-auto align-self-end">
                    <button type="submit" class="btn btn-primary">조회</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 통계 요약 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card text-white bg-success mb-3">
                <div class="card-header">총 생성 수</div>
                <div class="card-body">
                    <h5 class="card-title" th:text="${createCount}">0</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- 차트 영역 -->
    <div class="row">
        <!-- 일별 생성/개봉 통계 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">일별 생성/개봉 통계</h5>
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 타입별 통계 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">타입별 통계</h5>
                    <canvas id="typeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center mt-4">
        <a href="/future-boxes" class="btn btn-secondary">FutureBox 목록으로</a>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script th:inline="javascript">
    const dailyStats = /*[[${dailyStats}]]*/ [];
    const typeStats = /*[[${typeStats}]]*/ [];

    // 일별 생성/개봉 차트
    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
    new Chart(dailyCtx, {
        type: 'line',
        data: {
            labels: dailyStats.map(stat => stat.date),
            datasets: [{
                label: '총 생성 수',
                data: dailyStats.map(stat => stat.totalCount),
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }, {
                label: '개봉 수',
                data: dailyStats.map(stat => stat.openedCount),
                borderColor: 'rgb(255, 99, 132)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // 타입별 통계 차트
    const typeCtx = document.getElementById('typeChart').getContext('2d');
    const typeCategories = [...new Set(typeStats.map(stat => stat.typeName.split(' - ')[0]))];
    const typeData = typeCategories.map(category => {
        const total = typeStats
            .filter(stat => stat.typeName.startsWith(category))
            .reduce((sum, stat) => sum + stat.count, 0);
        return total;
    });

    new Chart(typeCtx, {
        type: 'pie',
        data: {
            labels: typeCategories,
            datasets: [{
                label: '타입별 개수',
                data: typeData,
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 206, 86)'
                ]
            }]
        },
        options: {
            responsive: true
        }
    });
</script>
</body>
</html> 